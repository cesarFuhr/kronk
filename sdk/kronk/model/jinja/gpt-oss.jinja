{#-
  In addition to the normal inputs of `messages` and `tools`, this template also accepts the
  following kwargs:
  - "builtin_tools": A list, can contain "browser" and/or "python".
  - "model_identity": A string that optionally describes the model identity.
  - "reasoning_effort": A string that describes the reasoning effort, defaults to "medium".
  - "last_tool_call_name": (For gonja) Pre-computed last tool call name for tool messages.
 #}
{#- Tool Definition Rendering ============================================== #}
{%- macro render_typescript_type(param_spec, required_params) -%}
    {%- if param_spec.type == "array" -%}
        {%- if param_spec.items -%}
            {%- if param_spec.items.type == "string" -%}
                {{- "string[]" }}
            {%- elif param_spec.items.type == "number" -%}
                {{- "number[]" }}
            {%- elif param_spec.items.type == "integer" -%}
                {{- "number[]" }}
            {%- elif param_spec.items.type == "boolean" -%}
                {{- "boolean[]" }}
            {%- else -%}
                {{- "any[]" }}
            {%- endif -%}
            {%- if param_spec.nullable -%}
                {{- " | null" }}
            {%- endif -%}
        {%- else -%}
            {{- "any[]" }}
            {%- if param_spec.nullable -%}
                {{- " | null" }}
            {%- endif -%}
        {%- endif -%}
    {%- elif param_spec.oneOf -%}
        {{- "any" }}
    {%- elif param_spec.type == "string" -%}
        {%- if param_spec.enum -%}
            {{- '"' + param_spec.enum|join('" | "') + '"' -}}
        {%- else -%}
            {{- "string" }}
            {%- if param_spec.nullable %}
                {{- " | null" }}
            {%- endif -%}
        {%- endif -%}
    {%- elif param_spec.type == "number" -%}
        {{- "number" }}
    {%- elif param_spec.type == "integer" -%}
        {{- "number" }}
    {%- elif param_spec.type == "boolean" -%}
        {{- "boolean" }}
    {%- elif param_spec.type == "object" -%}
        {%- if param_spec.properties -%}
            {{- "{ " }}
            {%- for prop_name, prop_spec in param_spec.properties.items() -%}
                {{- prop_name -}}
                {%- if prop_name not in required_params -%}
                    {{- "?" }}
                {%- endif -%}
                {{- ": " }}
                {{- render_typescript_type(prop_spec, []) }}
                {%- if not loop.last -%}
                    {{- ", " }}
                {%- endif -%}
            {%- endfor -%}
            {{- " }" }}
        {%- else -%}
            {{- "object" }}
        {%- endif -%}
    {%- else -%}
        {{- "any" }}
    {%- endif -%}
{%- endmacro -%}
{%- macro render_tool_namespace(namespace_name, tools) -%}
    {{- "## " + namespace_name + "\n\n" }}
    {{- "namespace " + namespace_name + " {\n\n" }}
    {%- for tool in tools %}
        {%- set func = tool.function %}
        {{- "// " + func.description + "\n" }}
        {{- "type " + func.name + " = " }}
        {%- if func.parameters and func.parameters.properties %}
            {{- "(_: {\n" }}
            {%- for param_name, param_spec in func.parameters.properties.items() %}
                {%- if param_spec.description %}
                    {{- "// " + param_spec.description + "\n" }}
                {%- endif %}
                {{- param_name }}
                {%- if func.parameters.required -%}
                    {%- if param_name not in func.parameters.required -%}
                        {{- "?" }}
                    {%- endif -%}
                {%- else -%}
                    {{- "?" }}
                {%- endif -%}
                {{- ": " }}
                {%- if func.parameters.required -%}
                    {{- render_typescript_type(param_spec, func.parameters.required) }}
                {%- else -%}
                    {{- render_typescript_type(param_spec, []) }}
                {%- endif -%}
                {%- if param_spec.default is defined -%}
                    {{- ", // default: " }}{{ param_spec.default }}
                {%- endif -%}
                {{- ",\n" }}
            {%- endfor %}
            {{- "}) => any;\n\n" }}
        {%- else -%}
            {{- "() => any;\n\n" }}
        {%- endif -%}
    {%- endfor %}
    {{- "} // namespace " + namespace_name }}
{%- endmacro -%}
{%- macro render_builtin_tools(has_browser, has_python) -%}
    {%- if has_browser %}
        {{- "## browser\n\n" }}
        {{- "// Tool for browsing.\n" }}
        {{- "// The `cursor` appears in brackets before each browsing display: `[{cursor}]`.\n" }}
        {{- "// Cite information from the tool using the following format:\n" }}
        {{- "// `【{cursor}†L{line_start}(-L{line_end})?】`, for example: `【6†L9-L11】` or `【8†L3】`.\n" }}
        {{- "// Do not quote more than 10 words directly from the tool output.\n" }}
        {{- "// sources=web (default: web)\n" }}
        {{- "namespace browser {\n\n" }}
        {{- "// Searches for information related to `query` and displays `topn` results.\n" }}
        {{- "type search = (_: {\n" }}
        {{- "query: string,\n" }}
        {{- "topn?: number, // default: 10\n" }}
        {{- "source?: string,\n" }}
        {{- "}) => any;\n\n" }}
        {{- "// Opens the link `id` from the page indicated by `cursor` starting at line number `loc`, showing `num_lines` lines.\n" }}
        {{- "// Valid link ids are displayed with the formatting: `【{id}†.*】`.\n" }}
        {{- "// If `cursor` is not provided, the most recent page is implied.\n" }}
        {{- "// If `id` is a string, it is treated as a fully qualified URL associated with `source`.\n" }}
        {{- "// If `loc` is not provided, the viewport will be positioned at the beginning of the document or centered on the most relevant passage, if available.\n" }}
        {{- "// Use this function without `id` to scroll to a new location of an opened page.\n" }}
        {{- "type open = (_: {\n" }}
        {{- "id?: number | string, // default: -1\n" }}
        {{- "cursor?: number, // default: -1\n" }}
        {{- "loc?: number, // default: -1\n" }}
        {{- "num_lines?: number, // default: -1\n" }}
        {{- "view_source?: boolean, // default: false\n" }}
        {{- "source?: string,\n" }}
        {{- "}) => any;\n\n" }}
        {{- "// Finds exact matches of `pattern` in the current page, or the page given by `cursor`.\n" }}
        {{- "type find = (_: {\n" }}
        {{- "pattern: string,\n" }}
        {{- "cursor?: number, // default: -1\n" }}
        {{- "}) => any;\n\n" }}
        {{- "} // namespace browser\n\n" }}
    {%- endif -%}
    {%- if has_python %}
        {{- "## python\n\n" }}
        {{- "Use this tool to execute Python code in your chain of thought. The code will not be shown to the user. This tool should be used for internal reasoning, but not for code that is intended to be visible to the user (e.g. when creating plots, tables, or files).\n\n" }}
        {{- "When you send a message containing Python code to python, it will be executed in a stateful Jupyter notebook environment. python will respond with the output of the execution or time out after 120.0 seconds. The drive at '/mnt/data' can be used to save and persist user files. Internet access for this session is UNKNOWN. Depends on the cluster.\n\n" }}
    {%- endif -%}
{%- endmacro -%}
{#- System Message Construction ============================================ #}
{%- macro build_system_message() -%}
    {%- if model_identity -%}
        {{- model_identity + "\n" }}
    {%- else -%}
        {{- "You are ChatGPT, a large language model trained by OpenAI.\n" }}
    {%- endif -%}
    {{- "Knowledge cutoff: 2024-06\n" }}
    {{- "Current date: " + strftime_now("%Y-%m-%d") + "\n\n" }}
    {%- if reasoning_effort -%}
        {{- "Reasoning: " + reasoning_effort + "\n\n" }}
    {%- else -%}
        {{- "Reasoning: medium\n\n" }}
    {%- endif -%}
    {%- if builtin_tools %}
        {{- "# Tools\n\n" }}
        {%- set has_browser = false -%}
        {%- set has_python = false -%}
        {%- for tool in builtin_tools %}
            {%- if tool == "browser" %}
                {%- set has_browser = true %}
            {%- elif tool == "python" %}
                {%- set has_python = true %}
            {%- endif %}
        {%- endfor %}
        {{- render_builtin_tools(has_browser, has_python) }}
    {%- endif -%}
    {{- "# Valid channels: analysis, commentary, final. Channel must be included for every message." }}
    {%- if tools -%}
        {{- "\nCalls to these tools must go to the commentary channel: 'functions'." }}
    {%- endif -%}
{%- endmacro -%}
{#- Main Template Logic ================================================= #}
{#- Render system message #}
{{- "<|start|>system<|message|>" }}
{{- build_system_message() }}
{{- "<|end|>" }}
{#- Extract developer message #}
{%- set developer_message = "" %}
{%- set loop_messages = messages %}
{%- if messages and messages[0] %}
    {%- if messages[0].role == "developer" or messages[0].role == "system" %}
        {%- set developer_message = messages[0].content %}
        {%- set loop_messages = messages[1:] %}
    {%- endif %}
{%- endif %}
{#- Render developer message #}
{%- if developer_message or tools %}
    {{- "<|start|>developer<|message|>" }}
    {%- if developer_message %}
        {{- "# Instructions\n\n" }}
        {{- developer_message }}
        {{- "\n\n" }}
    {%- endif %}
    {%- if tools -%}
        {{- "# Tools\n\n" }}
        {{- render_tool_namespace("functions", tools) }}
    {%- endif -%}
    {{- "<|end|>" }}
{%- endif %}
{#- Render messages #}
{#- Note: For tool messages, you must pass "last_tool_call_name" from Go code #}
{#- since gonja doesn't support mutable state in loops #}
{%- for message in loop_messages -%}
    {%- if message.role == 'assistant' -%}
        {%- if message.tool_calls -%}
            {#- Handle tool calls #}
            {%- set tool_call = message.tool_calls[0] %}
            {%- if tool_call.function %}
                {%- set tc_name = tool_call.function.name %}
                {%- set tc_args = tool_call.function.arguments %}
            {%- else %}
                {%- set tc_name = tool_call.name %}
                {%- set tc_args = tool_call.arguments %}
            {%- endif %}
            {%- if message.thinking %}
                {{- "<|start|>assistant<|channel|>analysis<|message|>" + message.thinking + "<|end|>" }}
            {%- elif message.content %}
                {{- "<|start|>assistant<|channel|>analysis<|message|>" + message.content + "<|end|>" }}
            {%- endif %}
            {{- "<|start|>assistant to=" }}
            {{- "functions." + tc_name + "<|channel|>commentary " }}
            {%- if tool_call.content_type -%}
                {{- tool_call.content_type + "<|message|>" }}
            {%- else -%}
                {{- "json<|message|>" }}
            {%- endif -%}
            {{- tc_args|tojson }}
            {{- "<|call|>" }}
        {%- else -%}
            {#- Regular assistant message #}
            {%- if loop.last and not add_generation_prompt %}
                {%- if message.thinking %}
                    {{- "<|start|>assistant<|channel|>analysis<|message|>" + message.thinking + "<|end|>" }}
                {%- endif %}
                {{- "<|start|>assistant<|channel|>final<|message|>" + message.content + "<|return|>" }}
            {%- else %}
                {{- "<|start|>assistant<|channel|>final<|message|>" + message.content + "<|end|>" }}
            {%- endif %}
        {%- endif -%}
    {%- elif message.role == 'tool' -%}
        {#- Tool response message #}
        {#- Requires message.tool_call_name to be set by Go code #}
        {%- if message.tool_call_name -%}
            {{- "<|start|>functions." + message.tool_call_name }}
            {{- " to=assistant<|channel|>commentary<|message|>" + message.content|tojson + "<|end|>" }}
        {%- elif last_tool_call_name -%}
            {{- "<|start|>functions." + last_tool_call_name }}
            {{- " to=assistant<|channel|>commentary<|message|>" + message.content|tojson + "<|end|>" }}
        {%- endif -%}
    {%- elif message.role == 'user' -%}
        {{- "<|start|>user<|message|>" + message.content + "<|end|>" }}
    {%- endif -%}
{%- endfor -%}
{#- Generation prompt #}
{%- if add_generation_prompt -%}
<|start|>assistant
{%- endif -%}
